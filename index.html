<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATTENDANCE CREW CDC EAST</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <div class="login-container">
        <!-- Background Image -->
        <div class="background-image"></div>
        
        <div class="cover-container">
            <div class="logo-section">
                <div class="logo">CDC EAST</div>
                <h1 class="cover-title">ATTENDANCE CREW</h1>
                <p class="cover-subtitle">Sistem Terintegrasi Monitoring Kehadiran</p>
            </div>
            
            <div class="login-box">
                <div class="login-header">
                    <h2 class="login-title">Log In</h2>
                    <div class="login-icon">üîê</div>
                </div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <div class="input-icon">üìß</div>
                        <input type="email" id="email" required placeholder="Masukkan email Anda" value="bookingeast0@gmail.com">
                    </div>
                    <div class="form-group">
                        <div class="input-icon">üîí</div>
                        <input type="password" id="password" required placeholder="Masukkan password" value="password123">
                    </div>
                    <button type="submit" class="login-btn">
                        <span class="btn-icon">üöÄ</span>
                        MASUK KE APLIKASI
                    </button>
                </form>
                
                <div id="errorMessage" class="error-message"></div>
                
                <div class="login-footer">
                    <a href="#" class="change-password-link" onclick="showChangePassword()">
                        üîë Lupa Password / Ubah Password
                    </a>
                </div>
            </div>

            <!-- FOOTER COPYRIGHT BARU -->
            <div class="login-footer-copyright">
                <div class="footer-line">2025 Attendance Crew CDC East. All rights reserved.</div>
                <div class="footer-line">L=23-51Xe</div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîë Ubah Password</h3>
                <button class="close-btn" onclick="hideChangePassword()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="password" id="currentPassword" class="modal-input" placeholder="Password Saat Ini">
                <input type="password" id="newPassword" class="modal-input" placeholder="Password Baru (min. 6 karakter)">
                <input type="password" id="confirmPassword" class="modal-input" placeholder="Konfirmasi Password Baru">
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="changePassword()">
                    üíæ Ubah Password
                </button>
                <button class="modal-btn modal-btn-secondary" onclick="hideChangePassword()">
                    ‚ùå Batal
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs dari CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            updatePassword,
            reauthenticateWithCredential,
            EmailAuthProvider,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        // Firebase configuration - PASTIKAN INI BENAR!
        const firebaseConfig = {
            apiKey: "AIzaSyD8-YpoEE5vgN57q7-PP2GheiNU-W7uF9M",
            authDomain: "applikasi-absensi-d0588.firebaseapp.com",
            projectId: "applikasi-absensi-d0588",
            storageBucket: "applikasi-absensi-d0588.firebasestorage.app",
            messagingSenderId: "259203444953",
            appId: "1:259203444953:web:375cb5942bc5b76f2d8ec8",
            measurementId: "G-B2R2DC012T"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Test koneksi Firebase
        console.log("Firebase initialized:", app.name);

        // Login function
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.querySelector('.login-btn');

            // Show loading state
            loginBtn.innerHTML = '<span class="btn-icon">‚è≥</span> MEMPROSES...';
            loginBtn.disabled = true;
            errorMessage.style.display = 'none';

            try {
                console.log("Attempting login with:", email);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                console.log("Login successful:", user.email);
                
                // Redirect ke dashboard
                window.location.href = 'dashboard.html';
                
            } catch (error) {
                console.error("Login error:", error);
                
                let errorMsg = '';
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMsg = 'Format email tidak valid';
                        break;
                    case 'auth/user-disabled':
                        errorMsg = 'Akun ini dinonaktifkan';
                        break;
                    case 'auth/user-not-found':
                        errorMsg = 'Email tidak ditemukan';
                        break;
                    case 'auth/wrong-password':
                        errorMsg = 'Password salah';
                        break;
                    case 'auth/network-request-failed':
                        errorMsg = 'Koneksi internet bermasalah';
                        break;
                    default:
                        errorMsg = `Terjadi kesalahan: ${error.message}`;
                }
                
                errorMessage.textContent = errorMsg;
                errorMessage.style.display = 'block';
                
                // Shake animation for error
                document.querySelector('.login-box').classList.add('shake');
                setTimeout(() => {
                    document.querySelector('.login-box').classList.remove('shake');
                }, 500);
                
            } finally {
                // Reset button state
                loginBtn.innerHTML = '<span class="btn-icon">üöÄ</span> MASUK KE APLIKASI';
                loginBtn.disabled = false;
            }
        });

        // Change Password Functions
        window.showChangePassword = function() {
            const user = auth.currentUser;
            if (!user) {
                alert('Silakan login terlebih dahulu!');
                return;
            }
            document.getElementById('changePasswordModal').style.display = 'flex';
        };

        window.hideChangePassword = function() {
            document.getElementById('changePasswordModal').style.display = 'none';
            // Clear fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        };

        window.changePassword = async function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Harap isi semua field!');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Password baru tidak cocok!');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password minimal 6 karakter!');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                alert('Silakan login terlebih dahulu!');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                
                alert('‚úÖ Password berhasil diubah!');
                hideChangePassword();
            } catch (error) {
                console.error('Password change error:', error);
                alert(`‚ùå Gagal mengubah password: ${error.message}`);
            }
        };

        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('changePasswordModal').style.display === 'flex') {
                    changePassword();
                } else {
                    document.getElementById('loginForm').dispatchEvent(new Event('submit'));
                }
            }
        });

        // Auto-focus on email field
        document.getElementById('email').focus();

        // Check if user is already logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User already logged in, redirecting...");
                window.location.href = 'dashboard.html';
            }
        });

    </script>
</body>
</html>
