<!-- general/rekap-overtime.html -->
<div class="section active">
    <div class="section-header">
        <h2>Rekap Over Time CDC EAST</h2>
        <div class="section-actions">
            <button class="btn btn-info" onclick="loadMyOvertime()">
                üìã Lihat Data Saya
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Form Entry Over Time</h3>
        </div>
        <div class="card-body">
            <form id="overtimeForm">
                <div class="form-group">
                    <label for="picName">Nama PIC/User:</label>
                    <input type="text" id="picName" class="form-control" required 
                           placeholder="Masukkan nama PIC/User">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="overtimeDate">Date:</label>
                        <input type="date" id="overtimeDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="startTime">Jam Mulai:</label>
                        <input type="time" id="startTime" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="endTime">Jam Selesai:</label>
                        <input type="time" id="endTime" class="form-control" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="totalProject">Total Project:</label>
                        <input type="number" id="totalProject" class="form-control" 
                               placeholder="Jumlah project">
                    </div>
                    <div class="form-group">
                        <label for="totalPlant">Total Plant:</label>
                        <input type="number" id="totalPlant" class="form-control" 
                               placeholder="Jumlah plant">
                    </div>
                </div>

                <div class="form-group">
                    <label for="plantName">Plant Name:</label>
                    <input type="text" id="plantName" class="form-control" 
                           placeholder="Nama plant">
                </div>

                <div class="form-group">
                    <label for="volume">Volume:</label>
                    <input type="number" id="volume" class="form-control" step="0.01" 
                           placeholder="Volume pekerjaan">
                </div>

                <div class="form-group">
                    <label for="uraianTugas">Uraian Tugas:</label>
                    <textarea id="uraianTugas" class="form-control" rows="4" 
                              placeholder="Deskripsi tugas yang dilakukan"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        üíæ Save
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">History Over Time Saya</h3>
        </div>
        <div class="card-body">
            <div class="filter-group">
                <input type="date" id="historyStartDate" class="filter-input">
                <input type="date" id="historyEndDate" class="filter-input">
                <button class="btn btn-primary" onclick="filterHistory()">
                    üîç Filter
                </button>
            </div>
            
            <div class="table-container">
                <table id="overtimeHistoryTable" class="data-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Tanggal</th>
                            <th>Jam Mulai</th>
                            <th>Jam Selesai</th>
                            <th>Durasi</th>
                            <th>Total Project</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="overtimeHistoryBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { db } from '../../js/firebase-config.js';
    import { Utils } from '../../js/utils.js';
    import { collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    class RekapOvertime {
        constructor() {
            this.currentUser = null;
            this.init();
        }

        async init() {
            // Get current user info
            const auth = await import('../../js/auth.js');
            this.currentUser = auth.AuthManager.getCurrentUser();
            
            this.setupEventListeners();
            this.loadOvertimeHistory();
            this.setDefaultDate();
        }

        setDefaultDate() {
            document.getElementById('overtimeDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('picName').value = this.currentUser?.email || '';
        }

        setupEventListeners() {
            document.getElementById('overtimeForm').addEventListener('submit', (e) => this.submitForm(e));
            document.getElementById('historyStartDate').addEventListener('change', () => this.filterHistory());
            document.getElementById('historyEndDate').addEventListener('change', () => this.filterHistory());
        }

        async submitForm(e) {
            e.preventDefault();
            
            const formData = {
                picName: document.getElementById('picName').value,
                date: document.getElementById('overtimeDate').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                totalProject: parseInt(document.getElementById('totalProject').value) || 0,
                totalPlant: parseInt(document.getElementById('totalPlant').value) || 0,
                plantName: document.getElementById('plantName').value,
                volume: parseFloat(document.getElementById('volume').value) || 0,
                uraianTugas: document.getElementById('uraianTugas').value,
                userId: this.currentUser.uid,
                userEmail: this.currentUser.email,
                createdAt: new Date(),
                status: 'pending',
                duration: this.calculateDuration()
            };

            // Validation
            if (!this.validateForm(formData)) {
                return;
            }

            Utils.showLoading();

            try {
                await addDoc(collection(db, "overtime"), formData);
                alert('Data overtime berhasil disimpan!');
                this.resetForm();
                this.loadOvertimeHistory();
            } catch (error) {
                console.error('Error saving overtime:', error);
                alert('Error: ' + error.message);
            } finally {
                Utils.hideLoading();
            }
        }

        validateForm(data) {
            if (!data.picName) {
                alert('Nama PIC harus diisi!');
                return false;
            }
            
            if (!data.date) {
                alert('Tanggal harus diisi!');
                return false;
            }
            
            if (!data.startTime || !data.endTime) {
                alert('Jam mulai dan selesai harus diisi!');
                return false;
            }
            
            if (data.startTime >= data.endTime) {
                alert('Jam selesai harus setelah jam mulai!');
                return false;
            }
            
            return true;
        }

        calculateDuration() {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            
            if (!start || !end) return 0;
            
            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            const durationMs = endTime - startTime;
            return (durationMs / (1000 * 60 * 60)).toFixed(2); // Convert to hours
        }

        resetForm() {
            document.getElementById('overtimeForm').reset();
            this.setDefaultDate();
        }

        async loadOvertimeHistory() {
            if (!this.currentUser) return;
            
            Utils.showLoading();
            
            try {
                const q = query(
                    collection(db, "overtime"),
                    where("userId", "==", this.currentUser.uid),
                    orderBy("createdAt", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                this.overtimeData = [];
                
                querySnapshot.forEach(doc => {
                    this.overtimeData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                this.renderHistoryTable();
            } catch (error) {
                console.error('Error loading overtime history:', error);
            } finally {
                Utils.hideLoading();
            }
        }

        renderHistoryTable() {
            const tbody = document.getElementById('overtimeHistoryBody');
            tbody.innerHTML = '';

            if (this.overtimeData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">Belum ada data overtime</td>
                    </tr>
                `;
                return;
            }

            this.overtimeData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${Utils.formatDate(item.date)}</td>
                    <td>${item.startTime}</td>
                    <td>${item.endTime}</td>
                    <td>${item.duration || this.calculateDurationFromTimes(item.startTime, item.endTime)} jam</td>
                    <td>${item.totalProject || 0}</td>
                    <td>
                        <span class="badge ${this.getStatusBadgeClass(item.status)}">
                            ${item.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="rekapOvertime.deleteEntry('${item.id}')">
                            üóëÔ∏è Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        calculateDurationFromTimes(startTime, endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            const durationMs = end - start;
            return (durationMs / (1000 * 60 * 60)).toFixed(2);
        }

        getStatusBadgeClass(status) {
            switch (status) {
                case 'approved': return 'badge-success';
                case 'pending': return 'badge-warning';
                case 'rejected': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        async deleteEntry(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                return;
            }

            Utils.showLoading();
            
            try {
                await deleteDoc(doc(db, "overtime", id));
                alert('Data berhasil dihapus!');
                this.loadOvertimeHistory();
            } catch (error) {
                console.error('Error deleting overtime:', error);
                alert('Error: ' + error.message);
            } finally {
                Utils.hideLoading();
            }
        }

        filterHistory() {
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            
            if (!startDate || !endDate) {
                this.renderHistoryTable();
                return;
            }

            const filteredData = this.overtimeData.filter(item => {
                const itemDate = new Date(item.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                return itemDate >= start && itemDate <= end;
            });

            this.renderFilteredHistory(filteredData);
        }

        renderFilteredHistory(data) {
            const tbody = document.getElementById('overtimeHistoryBody');
            tbody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${Utils.formatDate(item.date)}</td>
                    <td>${item.startTime}</td>
                    <td>${item.endTime}</td>
                    <td>${item.duration || this.calculateDurationFromTimes(item.startTime, item.endTime)} jam</td>
                    <td>${item.totalProject || 0}</td>
                    <td>
                        <span class="badge ${this.getStatusBadgeClass(item.status)}">
                            ${item.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="rekapOvertime.deleteEntry('${item.id}')">
                            üóëÔ∏è Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    // Initialize
    const rekapOvertime = new RekapOvertime();

    // Global functions
    window.loadMyOvertime = function() {
        rekapOvertime.loadOvertimeHistory();
    };

    window.filterHistory = function() {
        rekapOvertime.filterHistory();
    };

    window.resetForm = function() {
        rekapOvertime.resetForm();
    };
</script>

<style>
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .form-control {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #8B0000;
        box-shadow: 0 0 0 2px rgba(139, 0, 0, 0.1);
    }
</style>
